services:

  traefik:
    image: traefik:v2.5
    ports:
      - "80:80"
      - "433:433"
      - "8080:8080"
      - "5433:5432"
      - "6379:6379"   

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml
      - ./traefik/config.yml:/etc/traefik/config.yml
      - ./traefik/certs:/etc/certs
    networks:  
      - microservice_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik=true"

  postgresql:
    container_name: postgresql
    image: postgres:15.6-bullseye
    networks:
      - microservice_network
    # ports: 
    #   - "5433:5432"
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD} 
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - PGDATA=/var/lib/data
    volumes:
      - ./data:/var/lib/data
    labels:
      - "traefik.enable=true"
      - "traefik.tcp.routers.postgresql.rule=HostSNI(`*`)"
      - "traefik.tcp.routers.postgresql.entrypoints=postgresql"
      - "traefik.tcp.routers.postgresql.service=postgresql"
      - "traefik.tcp.services.postgresql.loadbalancer.server.port=5432"
    depends_on:
      - traefik

  redis:
    container_name: redis
    image: redis:7.2.4-bookworm
    networks:
      - microservice_network
    # ports:
    #   - "6379:6379"
    volumes:
      - ./data/redis:/data
    labels:
    - "traefik.enable=true"
    - "traefik.tcp.routers.redis.rule=HostSNI(`*`)"
    - "traefik.tcp.routers.redis.entryPoints=redis"
    - "traefik.tcp.routers.redis.service=redis"
    - "traefik.tcp.services.redis.loadbalancer.server.port=6379"
    depends_on:
      - postgresql
      
  microserviceClient:
    image: microservice-client:1.0
    networks:
      - microservice_network
    
    depends_on:
      - redis
    labels:
        - "traefik.enable=true"
        - "traefik.http.services.microserviceClient.loadbalancer.server.port=5000"
        - "traefik.docker.network=microservice_network"

networks:
  microservice_network:
    external: true
    driver: bridge